---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: podinfo-app
  namespace: flux-system
spec:
  interval: 15m
  sourceRef:
    kind: GitRepository
    name: flux-system
#  serviceAccountName: kustomize-controller
  path: ./platform/podinfo/_base
  prune: false
  wait: true
  timeout: 5m
  postBuild:
    substitute:
      namespace_name: podinfo

  patches:
    - target:
        kind: Kustomization
        name: podinfo
      patch: |-
        kind: Kustomization
        metadata:
          name: podinfo
        spec:
          patches:
            - target:
                kind: HorizontalPodAutoscaler
                name: podinfo
                namespace: podinfo
              patch: |-
                apiVersion: autoscaling/v2
                kind: HorizontalPodAutoscaler
                metadata:
                  name: podinfo
                  namespace: ${namespace_name}
                spec:
                  minReplicas: 2
                  maxReplicas: 7